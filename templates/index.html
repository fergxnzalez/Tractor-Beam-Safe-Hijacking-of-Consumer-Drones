<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tractor Beam C2 - Pro</title>
    <style>
        body { background-color: #1a1a1a; color: #0f0; font-family: 'Consolas', monospace; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        
        .panel { border: 1px solid #444; padding: 15px; background: #222; margin-bottom:10px; }
        h3 { margin-top: 0; color: #fff; border-bottom: 1px solid #004400; padding-bottom: 5px;}
        
        input, select, button { width: 100%; padding: 10px; margin-top: 5px; background: #333; color: #fff; border: 1px solid #555; }
        
        /* Special Buttons */
        .btn-connect { background: #004488; }
        .btn-takeoff { background: #aa8800; color: #fff; font-weight: bold; border-color: #ccaa00; }
        .btn-start { background: #006600; font-weight: bold; margin-top: 15px;}
        .btn-stop { background: #880000; font-weight: bold; }
        button:hover { filter: brightness(1.2); cursor: pointer; }

        /* Telemetry and Status */
        .metric-box { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 5px 0; }
        .val { font-weight: bold; color: #fff; }
        .good { color: #0f0; } .bad { color: #f00; } .warn { color: #ff0; }

        /* Live Attack Panel */
        #attack-panel { border: 1px solid #f00; background: #2a0000; display: none; }
        .phase-text { font-size: 1.2em; text-align: center; padding: 10px; font-weight: bold; }
        .success-metric { font-size: 2em; text-align: center; color: #fff; margin: 10px 0; }
        .label-metric { text-align: center; color: #aaa; font-size: 0.8em; }

        #console { height: 120px; overflow-y: auto; background: #000; border: 1px solid #555; padding: 5px; font-size: 0.8em; color: #ccc; }
    </style>
</head>
<body>

    <h1 style="text-align:center; border-bottom:2px solid #0f0;">TRACTOR BEAM <span style="color:#fff">C2</span></h1>

<div class="container">

    <div>
        <div class="panel">
            <h3>1. System and Flight</h3>
            <div style="display:flex; gap:5px;">
                <input type="text" id="connString" value="127.0.0.1:14550">
                <button class="btn-connect" onclick="connectDrone()">LINK</button>
            </div>
            
            <button class="btn-takeoff" onclick="takeoff()" style="margin-top:15px;">
                ðŸš€ AUTO TAKEOFF & PREP (15m)
            </button>

            <div style="margin-top: 20px;">
                <div class="metric-box"><span>Status:</span> <span id="t-conn" class="bad">OFFLINE</span></div>
                <div class="metric-box"><span>Mode:</span> <span id="t-mode" class="val">---</span></div>
                <div class="metric-box"><span>Altitude:</span> <span id="t-alt" class="val">0m</span></div>
                <div class="metric-box"><span>GPS:</span> <span id="t-gps" class="val">---</span></div>
            </div>
        </div>

        <div class="panel" id="attack-panel">
            <div style="text-align:center; background:#f00; color:#fff; font-weight:bold;">ATTACK IN PROGRESS</div>
            <div class="phase-text" id="att-phase">INIT</div>
            
            <div class="label-metric">DISTANCE TRAVELED (SUCCESS)</div>
            <div class="success-metric" id="att-dist">0.0 m</div>
        </div>
    </div>

    <div class="panel">
        <h3>2. Payload Configuration</h3>
        
        <label>Strategy</label>
        <select id="strategy" onchange="toggleParams()">
            <option value="A">Strategy A (Station Keeping)</option>
            <option value="B">Strategy B (Path Following)</option>
        </select>

        <label>Target Displacement (North / East)</label>
        <div style="display:flex; gap:5px;">
            <input type="number" id="n_offset" placeholder="North (m)" value="50">
            <input type="number" id="e_offset" placeholder="East (m)" value="0">
        </div>

        <div id="paramA">
            <label>Iterations</label>
            <input type="number" id="iterations" value="300">
        </div>
        <div id="paramB" style="display:none;">
            <label>K Factor</label>
            <input type="number" id="k_factor" value="-1.0">
        </div>

        <button onclick="startAttack()" class="btn-start">START HIJACKING</button>
        <button onclick="stopAttack()" class="btn-stop">STOP</button>
    </div>

    <div class="panel full-width">
        <h3>Event Log</h3>
        <div id="console"></div>
    </div>
</div>

<script>
    let telInterval = null;

    function log(msg) {
        const c = document.getElementById('console');
        const t = new Date().toLocaleTimeString();
        c.innerHTML += `<div>[${t}] ${msg}</div>`;
        c.scrollTop = c.scrollHeight;
    }

    function toggleParams() {
        const s = document.getElementById('strategy').value;
        document.getElementById('paramA').style.display = (s === 'A') ? 'block' : 'none';
        document.getElementById('paramB').style.display = (s === 'B') ? 'block' : 'none';
    }

    async function req(ep, data) {
        const r = await fetch(ep, {
            method: 'POST', 
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        return await r.json();
    }

    async function connectDrone() {
        const ip = document.getElementById('connString').value;
        log("Connecting...");
        const res = await req('/connect', {ip: ip});
        if(res.status === 'success') { 
            log("Connected."); startTel(); 
        } else { log("Error: " + res.message); }
    }

    async function takeoff() {
        log("Starting takeoff sequence...");
        const res = await req('/takeoff', {});
        if(res.status === 'success') log(res.message);
        else log("Takeoff Error: " + res.message);
    }

    async function startAttack() {
        const s = document.getElementById('strategy').value;
        const n = document.getElementById('n_offset').value;
        const e = document.getElementById('e_offset').value;
        const p = (s==='A') ? document.getElementById('iterations').value : document.getElementById('k_factor').value;
        
        const res = await req('/start', {strategy: s, n_offset: n, e_offset: e, param: p});
        if(res.status === 'success') log("Attack STARTED."); 
        else alert(res.message);
    }

    async function stopAttack() {
        await req('/stop', {});
        log("Attack stopped.");
    }

    function startTel() {
        if(telInterval) clearInterval(telInterval);
        telInterval = setInterval(async () => {
            const res = await fetch('/status');
            const d = await res.json();
            
            if(!d.connected) {
                document.getElementById('t-conn').innerText = "OFFLINE";
                document.getElementById('t-conn').className = "bad";
                return;
            }

            // Update Basic Telemetry
            document.getElementById('t-conn').innerText = "ONLINE";
            document.getElementById('t-conn').className = "good";
            document.getElementById('t-mode').innerText = d.mode;
            document.getElementById('t-alt').innerText = d.alt.toFixed(1) + " m";
            document.getElementById('t-gps').innerText = d.gps_fix >= 3 ? "3D FIX (" + d.satellites + ")" : "NO FIX";
            document.getElementById('t-gps').className = d.gps_fix >= 3 ? "good" : "bad";

            // Update Attack Panel
            const att = d.attack_data;
            const attPanel = document.getElementById('attack-panel');
            
            if(att && att.active) {
                attPanel.style.display = 'block';
                document.getElementById('att-phase').innerText = att.phase;
                // If in Hard Spoofing (Jamming), blink/change color
                document.getElementById('att-phase').style.color = (att.phase.includes("JAMMING")) ? "#ff0" : "#fff";
                
                document.getElementById('att-dist').innerText = att.distance_moved.toFixed(1) + " m";
            } else {
                attPanel.style.display = 'none';
            }

        }, 1000);
    }
</script>

</body>
</html>